{% extends "base.html" %}


{% block maincontents %}
  <div class="row">
    <div class="col-md-12">
      <div class="grid simple">
        <div class="grid-body grid-page-title">
          <h3 class="inline">Update Details : <span class="semi-bold">{{ employee.first_name|capitalize }} {{ employee.last_name|capitalize }}</span></h3>
          <h3 class="v-align-middle pull-right"><a href="{{ url_for("admin_views.admin_organisation_dashboard", org_id=org.id) }}">{{ org.name }}</a></h3>
          <div class="clearfix"></div>
        </div>
        <div class="grid-body">
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <ul class="flashes list-unstyled alert alert-danger">
                  {% for message in messages %}
                    <li>{{ message }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endwith %}
            <form class="form-no-horizontal-spacing" id="form-organisation-emp" method="post" action="{{ url_for("admin_views.admin_organisation_add_emp_details", org_id=org.id, emp_id=employee.id) }}">
              <div class="row column-seperation">
                <div class="col-md-6">
                  <h4>Basic Information </h4>
                  <div class="row form-row">
                    <div class="col-md-7">
                      <div class="input-with-icon  right">
                        <input name="first_name_add_organisation" type="text" class="form-control" placeholder="First Name" maxlength="30" value="{{ employee.first_name }}">
                      </div>
                    </div>
                    <div class="col-md-5">
                      <div class="input-with-icon  right">
                        <input name="last_name_add_organisation" type="text" class="form-control" placeholder="Last Name" maxlength="30" value="{{ employee.last_name }}">
                      </div>
                    </div>
                  </div>
                  <div class="row form-row">
                    <div class="col-md-12">
                      <div class="input-with-icon  right">
                        <input name="email_add_organisation" type="text" class="form-control" minlength="3" maxlength="100" value="{{ employee.email }}" disabled>
                      </div>
                    </div>
                  </div>
                  <div class="row form-row">
                    <div class="col-md-5">
                      <div class="input-append success date no-padding">
                        <input name="date_of_birth_add_organisation" type="text" class="form-control" placeholder="Date of Birth" value="{{ employee.date_of_birth }}">
                        <span class="add-on"><span class="arrow"></span><i class="fa fa-th"></i></span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="radio form-group">
                        <input id="male" type="radio" name="gender" value="male" {% if employee.gender == "male" %}checked{% endif %}>
                        <label for="male">Male</label>
                        <input id="female" type="radio" name="gender" value="female" {% if employee.gender == "female" %}checked{% endif %}>
                        <label for="female">Female</label>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                        <input id="active" type="checkbox" name="active" value="active" {% if employee.active %}checked="checked"{% endif %}>
                        <label class="checkbox-inline" for="account_status">Active</label>
                      </div>
                    </div>
                  </div>
                  <h4>Hierarchy</h4>
                  <div class="row form-row">
                    <div class="col-md-12 form-group">
                      <select name="role" id="role" class="select2 form-control">
                        <option value="{{ employee.hierarchy.id }}" data-level="{{ employee.hierarchy.level }}" selected disabled>({{ employee.hierarchy.title|upper }}) {{ employee.hierarchy.title_full|upper }}</option>
                        {% for designation in hierarchy %}
                        <option value="{{ designation.id }}" data-level="{{ designation.level }}">({{ designation.title|upper }}) {{ designation.title_full|upper }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <h4>Postal Information</h4>
                  <div class="row form-row">
                    <div class="col-md-12">
                      <div class="input-with-icon  right">
                        <input name="address_add_org_emp" type="text" class="form-control" placeholder="Address" value="{{ employee.postal_address }}">
                      </div>
                    </div>
                  </div>
                  <div class="row form-row">
                    <div class="col-md-6 form-group">
                      <div class="input-with-icon  right">
                        <select name="country_add_organisation" class="form-control select2" id="postal_country">
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6 ">
                      <div class="input-with-icon  right">
                        <select name="state_add_organisation" class="form-control select2" id="postal_state">
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="row form-row">
                    <div class="col-md-6 ">
                      <div class="input-with-icon  right">
                        <input name="city_add_organisation" type="text" class="form-control" placeholder="City" maxlength="30" value="{{ employee.postal_city }}">
                      </div>
                    </div>
                    <div class="col-md-6 ">
                      <div class="input-with-icon  right">
                        <input name="postal_code_add_organisation" type="text" class="form-control" placeholder="Postal Code" minlength="5" maxlength="6" value="{{ employee.postal_code }}">
                      </div>
                    </div>
                  </div>
                  <div class="row form-row">
                    <div class="col-md-4 ">
                      <div class="input-with-icon  right">
                        <input name="tele_code_add_organisation" type="text" class="form-control" placeholder="+91" minlength="1" maxlength="2" value="{{ employee.postal_tele_code }}">
                      </div>
                    </div>
                    <div class="col-md-8 ">
                      <div class="input-with-icon  right">
                        <input name="teleno_add_organisation" type="text" class="form-control" placeholder="Phone Number" maxlength="10" value="{{ employee.postal_telephone }}">
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-12">
                  <h4>Geography Details</h4>
                  <table class="table table-hover table-condensed" id="organisation-emp-table">
                      <thead>
                      <tr >
                          <th style="width:1%" >#</th>
                          <th style="width:15%">States</th>
                          <th style="width:15%">Regions</th>
                          <th style="width:5%">Areas</th>
                          <th style="width:20%">Branches</th>
                      </tr>
                      </thead>
                      <tbody>
                      {% for state in employee.states %}
                      <tr>
                          <td class="v-align-middle">{{ loop.index }}</td>
                          <td class="v-align-middle">{{ state.name }}</td>
                          <td class="v-align-middle">all regions</td>
                          <td class="v-align-middle">all areas</td>
                          <td class="v-align-middle">all branches</td>
                      </tr>
                      {% endfor %}

                      {% for region in employee.regions %}
                      <tr>
                          <td class="v-align-middle">{{ loop.index }}</td>
                          <td class="v-align-middle">{{ region.state }}</td>
                          <td class="v-align-middle">{{ region.name }}</td>
                          <td class="v-align-middle">all areas</td>
                          <td class="v-align-middle">all branches</td>
                      </tr>
                      {% endfor %}

                      {% for area in employee.areas %}
                      <tr>
                          <td class="v-align-middle">{{ loop.index }}</td>
                          <td class="v-align-middle">{{ area.state }}</td>
                          <td class="v-align-middle">{{ area.region }}</td>
                          <td class="v-align-middle">{{ area.name }}</td>
                          <td class="v-align-middle">all branches</td>
                      </tr>
                      {% endfor %}

                      {% for branch in employee.branches %}
                      <tr>
                          <td class="v-align-middle">{{ loop.index }}</td>
                          <td class="v-align-middle">{{ branch.state }}</td>
                          <td class="v-align-middle">{{ branch.region }}</td>
                          <td class="v-align-middle">{{ branch.area }}</td>
                          <td class="v-align-middle">{{ branch.name }}</td>
                      </tr>
                      {% endfor %}
                      </tbody>
                  </table>

                  <div class="row row-padding form-row">
                    <div class="col-md-3">
                      <h5 >Assign States Access</h5>
                      <!-- <select name="states" id="states" class="geo-select geo-state form-control" size="10" multiple> -->
                      <!-- </select> -->
                      <label name="states" id="states" ></label>
                    </div>

                    <div class="col-md-3">
                      <h5 >Assign Regions Access</h5>
                      <!-- <select name="regions" id="regions" class="geo-select geo-region form-control" size="10" multiple>
                      </select> -->
                      <label name="regions" id="regions" ></label>
                    </div>

                    <div class="col-md-3">
                      <h5 >Assign Areas Access</h5>
                      <!-- <select name="areas" id="areas" class="geo-select geo-area form-control" size="10" multiple>
                      </select> -->
                      <label type="checkbox" name="areas" id="areas" ></label>
                    </div>

                    <div class="col-md-3">
                      <h5>Assign Branches Access</h5>
                      <!-- <select name="branches" id="branches" class="geo-select geo-branch form-control" size="10" multiple>
                      </select> -->
                      <label type="checkbox" name="branches" id="branches" ></label>
                    </div>
                    <br>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <div class="pull-right">
                  <button class="btn btn-small btn-danger btn-cons" type="submit">Update Employee Details</button>
                  <button class="btn btn-small btn-white btn-cons cancel-button" type="reset" value="clear">Cancel</button>
                </div>
              </div>
            </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block js_scripts %}
  <script src="{{ url_for('static', filename='js/countries.js') }}" type="text/javascript"></script>
  <script type="text/javascript">
    $(document).ready(function(){
      var option=$("option:selected", $('#role'));
      var level = option.data('level');

      function disableCheckbox(geoTag){
        var label = $('#'+geoTag).find('*');
        $.each(label, function(){
          $(this).prop('disabled',true);
        });
      }

      function enableCheckbox(geoTag){
        var label = $('#'+geoTag).find('*');
        $.each(label, function(){
          $(this).prop('disabled',false);
        });
      }

      var accessLevelGTE = {
        "states" : 3,
        "regions" : 4,
        "areas" : 5,
        "branches" : 6,
      };

      var selection = {
        "states" : {
          {% for state in employee.states %}"{{ state.id }}" : {{ state.json|safe }},{% endfor %}
          {% for region in employee.regions %}"{{ region.state.id }}" : {{ region.state.json|safe }},{% endfor %}
          {% for area in employee.areas %}"{{ area.state.id }}" : {{ area.state.json|safe }},{% endfor %}
          {% for branch in employee.branches %}"{{ branch.state.id }}" : {{ branch.state.json|safe }},{% endfor %}
        },
        "regions" : {
          {% for region in employee.regions %}"{{ region.id }}" : {{ region.json|safe }},{% endfor %}
          {% for area in employee.areas %}"{{ area.region.id }}" : {{ area.region.json|safe }},{% endfor %}
          {% for branch in employee.branches %}"{{ branch.region.id }}" : {{ branch.region.json|safe }},{% endfor %}
        },
        "areas" : {
          {% for area in employee.areas %}"{{ area.id }}" : {{ area.json|safe }},{% endfor %}
          {% for branch in employee.branches %}"{{ branch.area.id }}" : {{ branch.area.json|safe }},{% endfor %}
        },
        "branches" : {
          {% for branch in employee.branches %}"{{ branch.id }}" : {{ branch.json|safe }},{% endfor %}
        }
      };

      function deselectCheckbox(geoTag){
        var label = $('#'+geoTag).find('*');
        $.each(label, function(){
          $(this).prop('checked',false);
        });
      }

      function removeChildren(geoTag){
        var label = $('#'+geoTag).find('*');
        $.each(label, function(){
          $(this).remove();
        });
        cleanup(geoTag);
      }

      function cleanup(geoTag){
        var toRemove = $('.class_'+geoTag);
        $.each(toRemove, function(){
          $(this).remove();
        });
      }

      $("#role").change(function(e) {
        startOnDeselect();

        $(".geo-select").prop('disabled', true);
        option = $("option:selected", this);
        level = $("option:selected", this).data('level');

        if (level >= accessLevelGTE["states"]) {
          $("#states").find('*').prop('disabled', false);
          var geoTag = "states";
          var geoUrl = "{{ url_for("admin_views.admin_org_states_list", org_id=org.id) }}/";
          populateGeoItems(geoTag, geoUrl,false);
        }
      });

      function startOnDeselect(){
        deselectCheckbox("states");

        removeChildren("regions");
        removeChildren("areas");
        removeChildren("branches");

        for(var area_id in selection["areas"]){
          var geoUrl = "{{ url_for("admin_views.admin_org_areas_list", org_id=org.id) }}?area_id="+area_id;
          deleteGeoItems("branches", geoUrl);
        }
        for(var region_id in selection["regions"]){
          var geoUrl = "{{ url_for("admin_views.admin_org_regions_list", org_id=org.id) }}?region_id="+region_id;
          deleteGeoItems("areas", geoUrl);
        }
        for(var state_id in selection["states"]){
          var geoUrl = "{{ url_for("admin_views.admin_org_states_list", org_id=org.id) }}?state_id="+state_id;
          deleteGeoItems("regions", geoUrl);
        }
      }

      $("#states").on('change','input',function(e){
        if($(this).prop("checked")==false){
          startOnDeselect();
        }
        var geoTag = "regions";
        var geoUrl = "{{ url_for("admin_views.admin_org_states_list", org_id=org.id) }}?state_id=" + this.value;
        if(level >= accessLevelGTE["regions"] && $(this).prop("checked")==true){
          $("#"+geoTag).find('*').prop('disabled', false);
          populateGeoItems(geoTag, geoUrl, false);
        }
      });

      $("#regions").on('change','input',function(e){
        if($(this).prop("checked")==false){
          startOnDeselect();
        }
        var geoTag = "areas";
        var geoUrl = "{{ url_for("admin_views.admin_org_regions_list", org_id=org.id) }}?region_id=" + this.value;
        if(level >= accessLevelGTE["areas"] && $(this).prop("checked")==true){
          $("#"+geoTag).find('*').prop('disabled', false);
          populateGeoItems(geoTag, geoUrl, false);
        }
      });

      $("#areas").on('change','input',function(e){
        if($(this).prop("checked")==false){
          startOnDeselect();
        }
        var geoTag = "branches";
        var geoUrl = "{{ url_for("admin_views.admin_org_areas_list", org_id=org.id) }}?area_id=" + this.value;
        if(level >= accessLevelGTE["branches"] && $(this).prop("checked")==true){
          $("#"+geoTag).find('*').prop('disabled', false);
          populateGeoItems(geoTag, geoUrl, false);
        }
      });

      var stateDisable=true,regionDisable=true,areaDisable=true,branchDisable=true;
      var geoToRemove = "states";

      if (level>=accessLevelGTE["states"]){
        stateDisable=false;
        geoToRemove = "regions";
      }
      if (level>=accessLevelGTE["regions"]) {
        regionDisable=false;
        geoToRemove = "areas";
      }
      if (level>=accessLevelGTE["areas"]) {
        areaDisable=false;
        geoToRemove = "branches";
      }
      if (level>=accessLevelGTE["branches"]) {
        branchDisable=false;
        geoToRemove = "centers";
      }

      /*Order Important?*/
      populateGeoElements("branches", selection.branches, branchDisable, true);
      populateGeoElements("areas", selection.areas, areaDisable, true);
      populateGeoElements("regions", selection.regions, regionDisable, true);
      populateGeoElements("states", selection.states, stateDisable, true);

      removeChildren(geoToRemove);

      function deleteGeoItems(geoTag, geoURL){
        $.ajax({
          cache: true,
          url: geoURL
        })

        .done(function(response){
          var children = response["children"];

          $.each(children, function(k, v) {
            if (v.id in selection[geoTag]) {
              delete selection[geoTag][v.id];
            }
          });
        });
      }

      function populateGeoItems(geoTag, geoURL, disable) {
        $.ajax({
          cache: true,
          url: geoURL
        })
        .done(function(response) {
          var children = response["children"];
          var el1 = _.map(children, 'id');
          var el2 = _.keys(selection[geoTag]);
          var reminder = _.difference(el1, el2);

          $.each(children, function(k, v) {
            if (!(v.id in selection[geoTag])) {
              selection[geoTag][v.id] = v;
            }
          });
          $.each(reminder, function(k, v) {
            var geoValue = selection[geoTag][v];
            var geoElement = "#" + geoTag;
            var opening;
            if(disable){
              opening = '<input type="checkbox" name="'+geoTag+'" class="geo-select geo-'+geoTag+'" value='+geoValue.id+' size="10" disabled/>';
            }else {
              opening = '<input type="checkbox" name="'+geoTag+'" class="geo-select geo-'+geoTag+'" value='+geoValue.id+' size="10" />';
            }
            var className = "class_"+geoTag

            var html_tag=opening+'<span class="'+className+'">'+geoValue.name+'</span>'+'<br>'

            $(geoElement).append(html_tag);
          });
        });
      }

      function populateGeoElements(geoTag, geoCollection, disable, checked) {
        var baseURL={
          "states":"{{ url_for("admin_views.admin_org_states_list", org_id=org.id) }}?state_id=",
          "regions":"{{ url_for("admin_views.admin_org_regions_list", org_id=org.id) }}?region_id=",
          "areas":"{{ url_for("admin_views.admin_org_areas_list", org_id=org.id) }}?area_id=",
          "branches":"{{ url_for("admin_views.admin_org_branches_list", org_id=org.id) }}branch_id=?",
        };

        $.each(geoCollection, function(k, v){
          var geoElement = "#" + geoTag;
          var opening;
          if(disable){
              if(checked){
                opening = '<input type="checkbox" name="'+geoTag+'" class="geo-select geo-'+geoTag+'" value='+v.id+' size="10" checked="True" disabled/>'
              }
              else{
                  opening = '<input type="checkbox" name="'+geoTag+'" class="geo-select geo-'+geoTag+'" value='+v.id+' size="10" disabled/>'
              }

          }else{
              if(checked){
                opening = '<input type="checkbox" name="'+geoTag+'" class="geo-select geo-'+geoTag+'" value='+v.id+' size="10" checked="True" />'
              }
              else{
                  opening = '<input type="checkbox" name="'+geoTag+'" class="geo-select geo-'+geoTag+'" value='+v.id+' size="10" />'
              }
          }

          var className = "class_"+geoTag

          var html_tag=opening+'<span class="'+className+'">'+v.name+'</span>'+'<br>';
          var element = $(geoElement).append(html_tag);

          if(geoTag=="states"){
            populateGeoItems(geoTag,"{{ url_for("admin_views.admin_org_states_list", org_id=org.id) }}",stateDisable);
          }
          var appendDisable=true;
          var geoURL = baseURL[geoTag] + v.id;
          var newGeoTag;
          switch (geoTag) {
            case "states":newGeoTag="regions";
              appendDisable=regionDisable;
              break;
            case "regions":newGeoTag="areas";
              appendDisable=areaDisable;
              break;
            case "areas":newGeoTag="branches";
              appendDisable=branchDisable;
              break;
            default: newGeoTag="";
              break;

          }
          if(geoTag!="branches" ){
            populateGeoItems(newGeoTag,geoURL,appendDisable);
          }
        });

      }
      function formValidation(){
        var st = $('#states').find('*');
        var count=0;
        $.each(st, function(){
          if($(this).prop('checked',false))
            count++;
        });
        if(count == st.length && level>=3){
          console.log("ERROR");
        }

        var reg = $('#regions').find('*');
        count =0;
        $.each(reg, function(){
          if($(this).prop('checked',false))
            count++;
        });
        if(count == reg.length && level>=4){
          console.log("ERROR");
        }
        var ar = $('#areas').find('*');
        count =0;
        $.each(ar, function(){
          if($(this).prop('checked',false))
            count++;
        });
        if(count == ar.length && level>=6){
          console.log("ERROR");
        }
        var br = $('#branches').find('*');
        count=0;
        $.each(br, function(){
          if($(this).prop('checked',true))
            count++;
        });
        if(count == br.length && level>=7){
          console.log("ERROR");
        }
      }
      populateCountries("postal_country", "postal_state", {
          "state" : "{{ employee.postal_state }}",
          "country" : "{{ employee.postal_country }}"
      });
      $("#postal_state").select2();
      $("#postal_country").select2();
      $("#role").select2({
        placeholder: "Select Designation",
        allowClear: true
      });

      $(':input','#form-organisation')
          .not(':button, :submit, :reset, :hidden')
          .val('')
          .removeAttr('checked')
          .removeAttr('selected');

      $.validator.addMethod("loginRegex", function(value, element) {
          return this.optional(element) || /^[a-z0-9\-\s]+\@{{ org.domain }}$/i.test(value);
      }, "username must contain only letters, numbers, or dashes.");

      $('#form-organisation-emp').validate({
        errorElement: 'span',
        errorClass: 'error',
        focusInvalid: false,
        ignore: "",
        rules: {
          // states:{
          //   depends:function(element){
          //     var st = $('#states').find('*');
          //     $.each(st,function(){
          //       if ($(this).prop("checked",true)){
          //         return (level>=3);
          //       }
          //     });
          //     return !(level>=3);
          //   }
          // },
          // regions:{
          //   depends:function(element){
          //     var st = $('#regions').find('*');
          //     $.each(st,function(){
          //       if ($(this).prop("checked",true)){
          //         return (level>=4);
          //       }
          //     });
          //     return !(level>=4);
          //   }
          // },
          // areas:{
          //   depends:function(element){
          //     var st = $('#areas').find('*');
          //     $.each(st,function(){
          //       if ($(this).prop("checked",true)){
          //         return (level>=6);
          //       }
          //     });
          //     return !(level>=6);
          //   }
          // },
          // branches:{
          //   depends:function(element){
          //     var st = $('#branches').find('*');
          //     $.each(st,function(){
          //       if ($(this).prop("checked",true)){
          //         return (level>=7);
          //       }
          //     });
          //     return !(level>=7);
          //   }
          // },
          first_name_add_organisation: {
            minlength: 2,
            maxlength: 30,
            required: true,
            lettersonly: true
          },
          last_name_add_organisation: {
            minlength: 2,
            maxlength: 30,
            required: true,
            lettersonly: true
          },
          email_add_organisation: {
            minlength: 3,
            maxlength: 100,
            required: true,
            loginRegex: true
          },
          password_add_organisation: {
            minlength: 3,
            maxlength: 30,
            required: true
          },
          address_add_org_emp: {
            minlength: 2,
            required: true
          },
          city_add_organisation: {
            minlength: 2,
            maxlength: 30,
            required: true,
            lettersonly: true
          },
          postal_code_add_organisation: {
            number:true,
            minlength: 5,
            maxlength: 6,
            required: true
          },
          teleno_add_organisation: {
            number:true,
            minlength: 10,
            maxlength: 10,
            required: true
          },
          tele_code_add_organisation: {
            minlength: 1,
            maxlength: 2,
            number:true,
            required: true
          }
        },
        invalidHandler: function (event, validator) {
          //display error alert on form submit
        },
        errorPlacement: function (error, element) { // render error placement for each input type
          var icon = $(element).parent('.input-with-icon').children('i');
          var parent = $(element).parent('.input-with-icon');
          icon.removeClass('fa fa-check').addClass('fa fa-exclamation');
          parent.removeClass('success-control').addClass('error-control');
        },
        highlight: function (element) { // hightlight error inputs
          var parent = $(element).parent();
          parent.removeClass('success-control').addClass('error-control');
        },
        unhighlight: function (element) { // revert the change done by hightlight

        },
        success: function (label, element) {
          var icon = $(element).parent('.input-with-icon').children('i');
          var parent = $(element).parent('.input-with-icon');
          icon.removeClass("fa fa-exclamation").addClass('fa fa-check');
          parent.removeClass('error-control').addClass('success-control');
        },
        submitHandler: function (form) {
          // formValidation();
          form.submit();
        }
      });
      $('.cancel-button').click(function(){
          location.href = '{{ url_for("admin_views.admin_organisation_add_emp", org_id=org.id) }}';
      });
      $('.input-append.date').datepicker({
        autoclose: true,
        todayHighlight: true
      });
    });
  </script>
{% endblock %}
